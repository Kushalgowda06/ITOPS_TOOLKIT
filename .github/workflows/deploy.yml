name: Deploy ITOps to EC2 - ECR Images

on:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_RELEASE }}
          aws-region: ap-southeast-1

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-southeast-1 | docker login --username AWS --password-stdin 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com

      - name: Create ECR repositories
        run: |
          aws ecr create-repository --repository-name itops-vault --region ap-southeast-1 || true
          aws ecr create-repository --repository-name itops-postgres --region ap-southeast-1 || true
          aws ecr create-repository --repository-name itops-backend --region ap-southeast-1 || true
          aws ecr create-repository --repository-name itops-frontend --region ap-southeast-1 || true

      - name: Build and push images
        run: |
          # Build and push Vault
          docker build -t 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-vault:latest ./ITOpsToolokit_Backend/vault_setup
          docker push 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-vault:latest

          # Build and push Postgres
          docker build -t 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-postgres:latest ./ITOpsToolokit_Backend/db_setup
          docker push 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-postgres:latest

          # Build and push Backend
          docker build -t 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-backend:latest ./ITOpsToolokit_Backend
          docker push 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-backend:latest

          # Build and push Frontend
          docker build -t 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-frontend:latest ./ITOpsToolokit_Frontend
          docker push 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-frontend:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Deploy to EC2
        run: |
          echo "${{ secrets.EC2_KEY_RELEASE }}" > ec2_key.pem
          chmod 600 ec2_key.pem

          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${{ secrets.EC2_USER_RELEASE }}@${{ secrets.EC2_HOST_RELEASE }} << 'EOF'
            # Install Docker and AWS CLI
            if ! command -v docker &> /dev/null; then
              sudo apt-get update -y
              sudo apt-get install -y docker.io awscli
              sudo systemctl enable docker
              sudo systemctl start docker
              sudo usermod -aG docker $USER
            fi

            # Login to ECR
            aws ecr get-login-password --region ap-southeast-1 | sudo docker login --username AWS --password-stdin 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com

            # Stop and remove ALL containers
            sudo docker stop $(sudo docker ps -q) 2>/dev/null || true
            sudo docker rm $(sudo docker ps -aq) 2>/dev/null || true
            sudo docker system prune -f

            # Create network
            sudo docker network create itops-network 2>/dev/null || true

            # Pull and run Vault
            sudo docker pull 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-vault:latest
            sudo docker run -d --name itops-vault --network itops-network -p 8200:8200 \
              -e VAULT_DEV_ROOT_TOKEN_ID=root -e VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200 \
              --cap-add IPC_LOCK 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-vault:latest

            # Pull and run Postgres
            sudo docker pull 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-postgres:latest
            sudo docker run -d --name itops-postgres --network itops-network -p 5432:5432 \
              -e POSTGRES_USER=postgres -e POSTGRES_PASSWORD=Postgres_2025 -e POSTGRES_DB=cfs_problem_tickets \
              361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-postgres:latest

            sleep 30

            # Pull and run Backend
            sudo docker pull 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-backend:latest
            sudo docker run -d --name itops-backend --network itops-network -p 8000:8000 \
              -e PGHOST=itops-postgres -e PGUSER=postgres -e PGPASSWORD=Postgres_2025 \
              -e PGDATABASE=cfs_problem_tickets -e VAULT_URL=http://itops-vault:8200 -e VAULT_TOKEN=root \
              361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-backend:latest

            sleep 15

            # Pull and run Frontend
            sudo docker pull 361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-frontend:latest
            sudo docker run -d --name itops-frontend --network itops-network -p 80:80 -p 443:443 \
              361568250748.dkr.ecr.ap-southeast-1.amazonaws.com/itops-frontend:latest

            echo "=== DEPLOYMENT COMPLETE ==="
            sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF

          rm -f ec2_key.pem
