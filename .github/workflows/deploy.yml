name: Deploy Vault to EC2

on:
  push:
    branches:
      - main
      - release/*

jobs:
  deploy-vault:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (optional)
        if: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE != '' && secrets.AWS_SECRET_ACCESS_KEY_RELEASE != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_RELEASE }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_RELEASE }}
          aws-region: ${{ secrets.AWS_REGION_RELEASE }}

      - name: Prepare EC2 key
        run: |
          echo "${{ secrets.EC2_KEY_RELEASE }}" > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Ensure remote dir exists and copy vault_setup to EC2
        run: |
          REMOTE_USER="${{ secrets.EC2_USER_RELEASE }}"
          REMOTE_HOST="${{ secrets.EC2_HOST_RELEASE }}"
          # Ensure the path from the runner exists
          if [ ! -d "ITOpsToolokit_Backend/vault_setup" ]; then
            echo "ERROR: local path ITOpsToolokit_Backend/vault_setup not found. Check repository layout."
            ls -la
            exit 1
          fi

          # Create remote dir and copy files
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} "mkdir -p /home/${REMOTE_USER}/vault_setup && chmod 755 /home/${REMOTE_USER}/vault_setup"
          scp -i ec2_key.pem -o StrictHostKeyChecking=no -r ITOpsToolokit_Backend/vault_setup/* ${REMOTE_USER}@${REMOTE_HOST}:/home/${REMOTE_USER}/vault_setup/

      - name: Deploy Vault on EC2 (build & run)
        env:
          REMOTE_USER: ${{ secrets.EC2_USER_RELEASE }}
          REMOTE_HOST: ${{ secrets.EC2_HOST_RELEASE }}
        run: |
          # NOTE: using a single-quoted heredoc on the runner side to avoid GitHub Actions interpolation issues
          ssh -i ec2_key.pem -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_HOST} <<'REMOTE_EOF'
            set -euo pipefail
            echo "---- Starting Vault Deployment on EC2 ----"

            # ensure docker exists (install if missing)
            if ! command -v docker >/dev/null 2>&1; then
              echo "Installing docker..."
              if command -v apt-get >/dev/null 2>&1; then
                sudo apt-get update -y
                sudo apt-get install -y docker.io
                sudo systemctl enable --now docker
              elif command -v yum >/dev/null 2>&1 || command -v dnf >/dev/null 2>&1; then
                sudo yum install -y docker || sudo dnf install -y docker
                sudo systemctl enable --now docker
              else
                echo "No known package manager to install docker. Install docker manually and re-run."
                exit 1
              fi
            fi

            # optional: install docker-compose if you use it remotely (uncomment if needed)
            # if ! docker compose version >/dev/null 2>&1; then
            #   sudo curl -L "https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            #   sudo chmod +x /usr/local/bin/docker-compose
            # fi

            cd /home/${USER:-ubuntu}/vault_setup || cd /home/ubuntu/vault_setup

            echo "Cleaning old containers and images..."
            docker rm -f vault || true
            docker rm -f vault-deploy-vault-1 || true
            docker rmi -f vault:latest || true
            docker image prune -af || true

            echo "Building image (if Dockerfile present)..."
            if [ -f Dockerfile ]; then
              docker build -t vault .
            else
              echo "No Dockerfile found in /home/${USER:-ubuntu}/vault_setup. Ensure Dockerfile exists."
            fi

            echo "Starting Vault container (name: vault)..."
            # Use the bind mounts so data + tls persist on host
            # Ensure host directories for mounts exist and have correct permissions
            sudo mkdir -p /opt/vault/data /opt/vault/tls /opt/vault/config
            sudo chown -R $(id -u):$(id -g) /opt/vault

            # Copy vault.hcl to host location if present inside repo copy
            if [ -f ./vault.hcl ]; then
              sudo cp ./vault.hcl /opt/vault/config/vault.hcl
            fi

            # Move any TLS files uploaded to host path if present
            if [ -d ./tls ]; then
              sudo cp -r ./tls/* /opt/vault/tls/ || true
            fi

            # Run container with IPC_LOCK cap and mlock disabled via config if needed
            docker run -d --name vault \
              -v /opt/vault/config:/vault/config \
              -v /opt/vault/data:/opt/vault/data \
              -v /opt/vault/tls:/opt/vault/tls \
              -p 8200:8200 \
              --cap-add IPC_LOCK \
              vault server -config=/vault/config/vault.hcl || \
            (echo "Failed to run container; logs:" && docker logs vault || true)

            echo "Waiting for Vault to become healthy..."
            for i in $(seq 1 30); do
              if docker exec vault sh -c "curl -ks https://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1"; then
                echo "Vault appears up."
                break
              fi
              sleep 3
            done

            echo "Container list:"
            docker ps -a
            echo "Vault logs (last 50 lines):"
            docker logs --tail 50 vault || true
            echo "---- Deployment finished ----"
          REMOTE_EOF

      - name: Remove EC2 private key
        if: always()
        run: rm -f ec2_key.pem
