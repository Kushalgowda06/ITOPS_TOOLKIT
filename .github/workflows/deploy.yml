name: Deploy Vault to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Step 1: Checkout repository
      # -------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------------------
      # Step 2: SSH into EC2 & Deploy Vault
      # -------------------------------
      - name: Deploy Vault on EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ubuntu
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "Starting Vault deployment..."

          # Create SSH key
          echo "$SSH_KEY" > vault_key.pem
          chmod 600 vault_key.pem

          # Connect to EC2
          ssh -o StrictHostKeyChecking=no -i vault_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'

            echo "*** Starting Vault Deployment ***"

            # Create directories for Vault under /home/ubuntu
            mkdir -p /home/ubuntu/vault/{config,data,tls}
            chmod -R 755 /home/ubuntu/vault

            # Stop any old Vault container
            docker stop vault || true
            docker rm vault || true

            # Create Vault config
            cat <<EOC > /home/ubuntu/vault/config/vault.hcl
ui = true

storage "file" {
  path = "/opt/vault/data"
}

listener "tcp" {
  address       = "0.0.0.0:8200"
  tls_cert_file = "/opt/vault/tls/tls.crt"
  tls_key_file  = "/opt/vault/tls/tls.key"
}

disable_mlock = true
api_addr = "https://$(curl -s http://checkip.amazonaws.com):8200"
EOC

            echo "Generating TLS certificates..."
            cd /home/ubuntu/vault/tls
            IP=$(curl -s http://checkip.amazonaws.com)
            openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
              -keyout tls.key -out tls.crt \
              -subj "/CN=${IP}" \
              -addext "subjectAltName=IP:${IP},DNS:localhost"

            echo "TLS certificate generated at /home/ubuntu/vault/tls"

            echo "Starting Vault container..."
            docker run -d --name vault \
              -v /home/ubuntu/vault/config:/opt/vault/config \
              -v /home/ubuntu/vault/data:/opt/vault/data \
              -v /home/ubuntu/vault/tls:/opt/vault/tls \
              -p 8200:8200 \
              --cap-add IPC_LOCK \
              vault:latest server -config=/opt/vault/config/vault.hcl

            echo "Waiting for Vault to start..."
            for i in {1..30}; do
              if curl -k https://127.0.0.1:8200/v1/sys/health >/dev/null 2>&1; then
                echo "Vault is up and running âœ…"
                break
              else
                echo "Vault not ready yet... retrying ($i)"
                sleep 3
              fi
            done

            echo "Vault container logs (last 20 lines):"
            docker logs --tail 20 vault

          EOF
