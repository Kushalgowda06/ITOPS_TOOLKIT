import { TextField } from "@mui/material";
import axios from "axios";
import { useEffect, useState } from "react";
import { FaArrowLeft, FaArrowRight } from "react-icons/fa6";
import { TbHazeMoon } from "react-icons/tb";
import testapi from "../../../api/testapi.json";
import { Loader } from "../../Utilities/Loader";
import { wrapIcon } from "../../Utilities/WrapIcons";


export const Vulnerability = ({ fieldsData, handleChange, setSec, handleNavigation, summary, handleReScan, GitHubLink, orderID }) => {

  const [isLoading, setIsLoading] = useState(false);
  const [scanResultText, setScanResultText] = useState([]) // scanResultTexts
  const [newScanResultText, setnewScanResultText] = useState([]) // scanResultTexts
  const FaArrowLeftIcon = wrapIcon(FaArrowLeft);
  const FaArrowRightIcon = wrapIcon(FaArrowRight);

  const [scanSummary, setScanSummary] = useState([]) // summary

  const [apiResultScan, setApiResultScan] = useState([])

  useEffect(() => {

    setIsLoading(true)
    try {

      let requestBody = {
        "OrderID": `${orderID}`,
        "GitHubLink": `${GitHubLink || "https://github.com/CognizantCodeHub/Cloud360/tree/main/Azure/terraform/AI/1744785639622"}`
      }
      axios.post(`${testapi.genAI_base_url}/gen_ai_chat_terrascan`, requestBody, {
        headers: {
          'Content-Type': "application/json"
        }
      }).then((response: any) => {
        // console.log(response.data.data, "ppp")
        setIsLoading(false);
        //   // setShowPrompt(false)
        //   setResource(true)
        //   setShowParameters(true);
        setApiResultScan(response.data.data[0].ScanResult)
        setScanResultText([{ "ScanResult": response.data.data[0].ScanResult[0] }]);
        setScanSummary(response.data.data[0].Summary[0])
      })
    } catch (error) {
      // setLoading(false);
      // console.error("Error in GET request:", error);
      // setScanResultTexts(["Error fetching data."]);
    } finally {
      // setLoading(false);
    }


  }, [])



  console.log("fieldsData", fieldsData)
  console.log(summary, "summary")
  console.log(apiResultScan, "apiResultScan")


  // console.log(scanResultTexts, '1 st ll')

  const [temp, setTemp] = useState(scanResultText)

  useEffect(() => {
    setTemp(scanResultText)
  }, [])

  useEffect(() => {
    setTemp(scanResultText)
  }, [scanResultText])

  // const onDeferClick = (index: number) => {
  //     var tempStore = [...scanResultTexts[0]]
  //     console.log(scanResultTexts[0], "ll")
  //     console.log(tempStore, "ll")
  //     if (tempStore.length) {
  //         console.log("here ll", tempStore)
  //         tempStore.splice(index, 1)
  //     }
  //     // console.log(tempStore , "after ll")

  //     setTemp([tempStore])
  // }

  const openInNewTab = (url) => {
    window.open(url, "_blank", "noreferrer");
  };

  useEffect(() => {
    if (apiResultScan && apiResultScan.length > 0) {
      const newScanResultTexts = apiResultScan.map((item) => {

        //   return Object.keys(item).map((result) => {
        return [ // Array of strings for each ScanResult
          `Rule Name: ${item.rule_name}   `,
          `Description: ${item.description}   `,
          `Rule ID: ${item.rule_id}   `,
          `Severity: ${item.severity}   `,
          `Category: ${item.category}   `,
          `Resource Name: ${item.resource_name}   `,
          `Resource Type: ${item.resource_type}   `,
          `Module Name: ${item.module_name}   `,
          `File: ${item.file}   `,
          `Line: ${item.line}`,
        ].join(''); // Join the array of strings into one string.
        //   });
        // } else {
        //   return ["No Scan Results available for this item."]; // Array for consistency
        // }
      });

      console.log(newScanResultTexts, "newscanresultTexts")
      setnewScanResultText(newScanResultTexts);
      //   setResource(true)

    } else {
      if (isLoading) {
        setnewScanResultText([["Loading..."]]); // Nested array for consistent structure
      } else {
        setnewScanResultText([["No data available. Click the button to fetch."]]); // Nested array
      }
    }

  }, [scanResultText]);

  console.log(temp, "rr")
  console.log(scanResultText, "scanResultText")
  return (
    <>
      <Loader isLoading={isLoading} load={null} />


      <div className=" mt-2">
        <div className="row">
          <div className=""> {/* Parameter Area */}
            <div className=" d-flex justify-content-center align-items-center" style={{ backgroundColor: "#2d2d8f", padding: "10px", color: "white" }}>
              <label>TerraScan Results</label>
            </div>
            <div className="container">
              <div className="row">
                <div className=" mt-2 d-flex justify-content-between">
                  <div>
                    {/* <label className="d-flex text-start">GitHubLink</label> */}
                    <TextField
                      type="text"
                      style={{ width: "34rem" }}
                      className="form-control "
                      value={GitHubLink || ""}
                      onChange={handleChange}
                      disabled
                      label="RepoLink"
                    />
                  </div>
                  <div style={{ paddingRight: "1rem" }}>
                    <span>OrderID : {orderID}</span>
                  </div>
                </div>
                <div className="col-md-6  p-2" >
                  <label>Vulnerabilities</label>
                  <div className="card shadow p-2 overflow-auto" style={{ height: "58vh", borderRadius: "initial" }}>
                    {/* <label className="d-flex text-start">GitHubLink</label> */}
                    {
                      newScanResultText.length && newScanResultText.map((itemResults, itemIndex) => (
                        // itemResults.map((text, resultIndex) => (
                        <div key={`${itemIndex}`}
                          style={{ display: 'flex', alignItems: 'center', marginBottom: '16px' }}>
                          <TextField
                            id={`scan-result-text-${itemIndex}`}
                            label={`Vulnerability ${itemIndex + 1}`}
                            className={`nav-font`}
                            multiline
                            rows={3}
                            fullWidth
                            value={itemResults}
                            InputProps={{ readOnly: true }}
                            style={{ flexGrow: 1, marginRight: '8px', marginTop: "1rem" }}
                          />
                          <button type="button" className="btn btn-primary mx-2 mt-2"> Fix </button>
                          <button type="button" onClick={() => { }} className="btn btn-primary mx-2 mt-2">  Defer</button>
                          <button type="button" onClick={() => { openInNewTab(fieldsData?.GitHubLink) }} className="btn btn-primary mx-2 mt-2"> GitHub</button>
                        </div>
                        // ))
                      ))
                    }
                  </div>
                </div>
                <div className="col-6 border-primary border-left border-1 p-2">
                  <label>Summary</label>
                  <div className="card shadow mx-2 p-2">
                    <ul className="list-group">
                      {Object.keys(scanSummary).length &&
                        Object.keys(scanSummary).map(element => {
                          return <li className="list-group-item f-size">
                            <span>{`${element}`} - {`${scanSummary[element]} \n`} </span>
                          </li>
                        })
                      }
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div className="row pt-2">
        <div className="col gap-2  d-flex justify-content-end">
          <button onClick={() => handleNavigation("showParametersPage")} className="btn btn-outline-primary rounded btn-lg mx-1 stack_btn_width">
            <FaArrowLeftIcon className="nav-link active pe-auto rounded-pill fw-bold" />
          </button>
          <button type="button" onClick={() => handleNavigation("showResourceDetailsPage")} className="btn btn-outline-primary rounded btn-lg mx-1 stack_btn_width">
            <FaArrowRightIcon className="nav-link active pe-auto rounded-pill fw-bold" />
          </button>
        </div>
      </div>
    </>
  )

}
